import telebot
import requests
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton
import time

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª
BOT_TOKEN = '8073109522:AAE-kaIo1gGCUZD45Yo9jizkDd-MkF_egAw'
RAPIDAPI_KEY = '0_2DL4DV3jcU1UOT7WGI1A4rY91'
API_HOST = 'aliexpress-datahub.p.rapidapi.com'
CHANNEL_USERNAME = '@alixpresscine'  # ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨ÙˆØª Ø£Ø¯Ù…Ù† ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©

bot = telebot.TeleBot(BOT_TOKEN)

@bot.message_handler(func=lambda message: 'aliexpress.com' in message.text.lower())
def handle_aliexpress_link(message):
    original_url = message.text.strip()

    headers = {
        'x-rapidapi-key': RAPIDAPI_KEY,
        'x-rapidapi-host': API_HOST
    }

    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ itemId Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    lookup_url = f'https://{API_HOST}/item_search_by_url?url={original_url}'
    try:
        lookup_response = requests.get(lookup_url, headers=headers, timeout=10)
        lookup_json = lookup_response.json()
        item_id = lookup_json.get('result', {}).get('itemId')
        if not item_id:
            bot.reply_to(message, "ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·.")
            return
    except Exception as e:
        bot.reply_to(message, "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø·.")
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ itemId: {e}")
        return

    # Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
    detail_url = f'https://{API_HOST}/item_detail_2?itemId={item_id}'
    try:
        detail_response = requests.get(detail_url, headers=headers, timeout=10)
        detail_json = detail_response.json()
        product = detail_json.get('result')
        if not product:
            bot.reply_to(message, "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬.")
            return
    except Exception as e:
        bot.reply_to(message, "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬.")
        print(f"Ø®Ø·Ø£ ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬: {e}")
        return

    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    title = product.get('subject', 'Ø§Ø³Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±')
    sale_price = product.get('salePrice', 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')
    original_price = product.get('originalPrice', 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')
    discount = product.get('discount', 'ØºÙŠØ± Ù…ØªÙˆÙØ±')
    image_url = product.get('imageUrl') or ""

    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    caption = f"""*ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ù„Ù‰ AliExpress:*

ğŸ›ï¸ *{title}*
ğŸ’² *Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:* {sale_price}
âŒ *Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚:* {original_price}
ğŸ”» *Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ®ÙÙŠØ¶:* {discount}

[Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø±Ø§Ø¡]({original_url})
"""

    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†", url=original_url))

    # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©
    try:
        if image_url:
            bot.send_photo(CHANNEL_USERNAME, image_url, caption=caption, parse_mode="Markdown", reply_markup=markup)
        else:
            bot.send_message(CHANNEL_USERNAME, caption, parse_mode="Markdown", reply_markup=markup)
    except Exception as e:
        print(f"Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø± ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©: {e}")

    # Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    try:
        if image_url:
            bot.send_photo(message.chat.id, image_url, caption=caption, parse_mode="Markdown", reply_markup=markup)
        else:
            bot.send_message(message.chat.id, caption, parse_mode="Markdown", reply_markup=markup)
    except Exception as e:
        print(f"Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
        bot.reply_to(message, "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬.")

# Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø± Ù…Ø¹ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø£Ø¹Ø·Ø§Ù„
while True:
    try:
        print("Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†...")
        bot.infinity_polling()
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„: {e}")
        print("Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù...")
        time.sleep(5)
